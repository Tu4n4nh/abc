## Tổng quan 
CVE-2021-43617 là lổ hổng liên quan đến việc bypass upload file của framework laravel ( < 8.72.0). Đặc biệt, lỗ hổng này chỉ ảnh hưởng đến các ứng dụng lavarel chạy trên hệ điều
hành Debian. Các ứng dụng trên hệ điều hành khác không bị ảnh hưởng. Team Lavarel đã đưa ra bản vá vào phiên bản (8.73.2), tuy nhiên theo tác giả của CVE này, lỗ hổng nằm ở việc
bypass cơ chế kiểm tra tập tin được tải lên bởi người dùng. Bài này sẽ đi phân tích theo hướng fix của team lavarel 

## Phân tích  
 
Mặc định lavarel sẽ cấm người dùng tải lên các tập tin `php`. Hàm kiểm tra nằm tại `Illuminate/Validation/Concerns/ValidatesAttributes.php` 
``` 
    protected function shouldBlockPhpUpload($value, $parameters)
    {
        if (in_array('php', $parameters)) {
            return false;
        }

        $phpExtensions = [
            'php', 'php3', 'php4', 'php5', 'phtml',
        ];

        return ($value instanceof UploadedFile)
           ? in_array(trim(strtolower($value->getClientOriginalExtension())), $phpExtensions)
           : in_array(trim(strtolower($value->getExtension())), $phpExtensions);
    }
```
Nhìn vào hàm này có thể nhận ra, laravel đã bỏ qua các tập tin có đuôi `.phar`(một định dạng có thể lợi dụng RCE). Đồng thời, Debian lại mặc định hỗ trợ thực thi cấc tập tin 
`.phar` này. Tập tin cấu hình php trên apache `/etc/apache2/mods-available/php@PHP_VERSION@.conf` 
```
# application/x-httpd-php                        phtml pht php
# application/x-httpd-php3                       php3
# application/x-httpd-php4                       php4
# application/x-httpd-php5                       php
<FilesMatch ".+\.ph(p[3457]?|t|tml)$">
    SetHandler application/x-httpd-php
</FilesMatch>
# application/x-httpd-php-source                 phps
    Require all denied
</FilesMatch>
# Deny access to files without filename (e.g. '.php')
<FilesMatch "^\.ph(p[3457]?|t|tml|ps)$">
    Require all denied
</FilesMatch>
``` 
Ngay sau khi lỗ hổng được công bố, lavarel đã thêm `.phar` vào bản vá mới của họ tại phiên bản 8.73.0. Debian cũng thực hiện cập nhật lại tập tin cấu hình của họ tại tất cả các 
phiên bản 
Bản vá lavarel 
``` 
    protected function shouldBlockPhpUpload($value, $parameters)
    {
        if (in_array('php', $parameters)) {
            return false;
        }

        $phpExtensions = [
            'php', 'php3', 'php4', 'php5', 'phtml', 'phar',
        ];

        return ($value instanceof UploadedFile)
           ? in_array(trim(strtolower($value->getClientOriginalExtension())), $phpExtensions)
           : in_array(trim(strtolower($value->getExtension())), $phpExtensions);
    }
``` 
Bản vá Debian 
```
# application/x-httpd-php                        phtml php
<FilesMatch ".+\.ph(ar|p|tml)$">
    SetHandler application/x-httpd-php
</FilesMatch>
# application/x-httpd-php-source                 phps
    Require all denied
</FilesMatch>
# Deny access to files without filename (e.g. '.php')
<FilesMatch "^\.ph(ar|p|ps|tml)$">
    Require all denied
</FilesMatch>
```  
 
![image](https://user-images.githubusercontent.com/22276823/143765773-f5e0fddc-dcba-4500-b2ed-7d348bff4a9d.png) 
 
Tuy nhiên, theo ý của tác giả, lỗ hổng nằm tại cơ chế kiểm tra tập tin của framework lavarel khi nó quá dễ để bypass. Cơ chế này hoạt động theo nguyên tắc sẽ quét 4 byte magic 
đầu tiên của tập tin để kiểm tra định dạng của tập tin. Kẻ tấn công có thể bypass bằng các thêm 4 byte magic này vào payload của mình để thực thi payload. Mặc dù không thể tải lên các tập tin `.phar` nhưng vẫn còn các attack vector khác như xss 

![image](https://user-images.githubusercontent.com/22276823/143765950-c29f1069-b639-4c18-9f4a-839d40e7069c.png) 



 
