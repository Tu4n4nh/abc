## Môi trường 
1. Ubuntu 
2. Php
3. Apache2 
4. Composer
 
## Cài đặt môi trường 
Tắt tường lửa trên Ubuntu 
```
sudo systemctl stop ufw
``` 

### Cài đặt PHP và các gói bổ trợ 
```
sudo apt install -y php7.4
sudo apt install -y php7.4-mysql php7.4-curl php7.4-json php7.4-cgi php7.4-xsl php7.4-mbstring php7.4-opcache php7.4-gd php7.4-pgsql php7.4-intl php7.4-bcmath php7.4-soap
``` 
 
### Cài đặt, cấu hình apache2 
```
sudo apt install apache2 -y 
```
Bật mode rewrite 
```
sudo a2enmod rewrite 
sudo systemctl restart apache2
``` 
 
Bật mode `AllowOverride` tại `/etc/apache2/apache2.conf` \
 
![image](https://user-images.githubusercontent.com/22276823/144421958-d4e0f81a-8f26-4b6e-95bc-118d0f0c8be8.png) 
 
Tạo một virtualhost mới. Sao chép tập tin cấu hình mặc định và đổi tên thành `laravel.conf`  
```
sudo cp /etc/apache2/sites-available/000-default.conf /etc/apache2/sites-available/laravel.conf 
``` 
Chỉnh sửa nội dung của `laravel.conf` 
 
![image](https://user-images.githubusercontent.com/22276823/144422954-16a9d597-fc3f-4192-822e-3c70604a639b.png) 
 
Sau khi đã chỉnh sửa xong thì khởi động lại dịch vụ `apache2` 
```
sudo systemctl restart apache2
``` 

### Cài composer 
```
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer
sudo chmod +x /usr/local/bin/composer
``` 
 
## Cài laravel 
Tải gói laravel từ github 
```
cd /var/www/html/
sudo git clone https://github.com/laravel/laravel.git
``` 
Di chuyển tới thư mục `laravel`. Tập tin `composer.json` sẽ chỉ định phiên bản của các thành phần trong ứng dụng laravel. Mở tập tin này và sửa phiên bản laravel framework thành
`8.70.2` 

![image](https://user-images.githubusercontent.com/22276823/144421365-456ec9f1-4b26-4b73-b1e0-1fe68a746d66.png) 
 
Lưu lại và cài đặt 
```
sudo composer install 
sudo composer fund
``` 

Để đổi phiên bản chỉ cần sửa tập tin `composer.json` và chạy 
```
sudo composer update
``` 
Truy cập thử với đường dẫn `http://ip:8080/`. 
 
![image](https://user-images.githubusercontent.com/22276823/144443148-917ef5f8-cc67-431e-8ede-bc03fface95e.png) 

## Demo 
Ở đây sẽ tạo ra một trang upload đơn giản. Vì laravel hoạt động theo mô hình MVC, nên cần tạo 3 tập tin tương ứng  
**Tập tin `/routes/web.php`** 
``` 
<?php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\ImageUploadController;

Route::get('/', function () {
    return view('welcome');
});

Route::get('image-upload', [ ImageUploadController::class, 'imageUpload' ])->name('image.upload');
Route::post('image-upload', [ ImageUploadController::class, 'imageUploadPost' ])->name('image.upload.post');
``` 
**Tập tin `app/Http/Controllers/ImageUploadController.php`** 
```
<?php
namespace App\Http\Controllers;
use Illuminate\Http\Request;
use Illuminate\Validation\Concerns\ValidatesAttributes;

class ImageUploadController extends Controller
{
/**
* Display a listing of the resource.

* @return \Illuminate\Http\Response
*/
public function imageUpload()
{
        return view('imageUpload');
}
/*** Display a listing of the resource.
*
* @return \Illuminate\Http\Response
*/
public function imageUploadPost(Request $request)
{
$request->validate([
        'image' => 'required|image|mimes:jpeg,png,jpg,gif,svg|max:2048',
]);

$imageName = time().'.'.$request->image->getClientOriginalExtension();

$request->image->move(public_path('images'), $imageName);

/* Store $imageName name in DATABASE from HERE */
return back()->with('success','You have successfully upload image.')->with('image',$imageName);
}
}
``` 
 
**Tập tin `resources/view/imageUpload.blade.php`** 
```
<!DOCTYPE html>
<html>
<head>
    <title>laravel 8 image upload vulnerability - Hosein Vita</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
</head>
<body>
<div class="container">
    <div class="panel panel-primary">
      <div class="panel-heading"><h2>laravel 8 image upload vulnerability - Hosein Vita</h2></div>
      <div class="panel-body">
        @if ($message = Session::get('success'))
        <div class="alert alert-success alert-block">
            <button type="button" class="close" data-dismiss="alert">×</button>
<strong>{{ $message }}</strong>
        </div>
        <img src="images/{{ Session::get('image') }}">
        @endif
        @if (count($errors) > 0)
            <div class="alert alert-danger">
                <strong>Whoops!</strong> There were some problems with your input.
                <ul>
                    @foreach ($errors->all() as $error)
                        <li>{{ $error }}</li>
                    @endforeach
                </ul>
            </div>
        @endif
        <form action="{{ route('image.upload.post') }}" method="POST" enctype="multipart/form-data">
            @csrf
            <div class="row">
                <div class="col-md-6">
                    <input type="file" name="image" class="form-control">
                </div>
                <div class="col-md-6">
                    <button type="submit" class="btn btn-success">Upload</button>
                </div>
            </div>
        </form>
      </div>
    </div>
</div>
</body>
</html>
``` 
 
Sau khi tạo 3 tập tin trên. Truy cập vào đường dẫn `http://ip:8080/image-upload` 
 
![image](https://user-images.githubusercontent.com/22276823/144424682-764986ac-3daf-4f5f-9e00-d32670c982b1.png) 
 
Tải lên tập tin `.phar` và mở cổng lắng nghe kết nối 
 
![image](https://user-images.githubusercontent.com/22276823/144425021-0dac6b1c-4088-405b-b35c-de9c19f07a65.png) 
 
![image](https://user-images.githubusercontent.com/22276823/144425191-848b1853-91da-4c05-8657-a8c23d0c5393.png) 
 
![image](https://user-images.githubusercontent.com/22276823/144425262-0b37e371-3d1b-4409-9b99-1e1d018e3bd1.png) 
 
Refference  
https://blog.hostvn.net/chia-se/huong-dan-cai-dat-laravel-tren-ubuntu-20-04-voi-lamp.html  
https://infosecwriteups.com/laravel-8-x-image-upload-bypass-zero-day-852bd806019b 




