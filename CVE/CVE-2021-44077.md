## Tổng quan 
Ngày 16/9/2021, trang chủ của ManageEngine đã đưa ra cảnh báo về lỗ hổng unauthenticated RCE trên dịch vụ ManageEngine ServiceDesk Plus. 
Mức độ: Critical 
Phiên bản: 
- Từ 11138 đến 11145 
- Từ 11200 đến 11305 

Lỗ hổng cho phép kẻ tấn công có thể upload file tùy ý và thực thi file mà không cần quyền xác thực.  

## Phân tích 
Theo như báo cáo thì đây là một lỗ hổng bỏ qua xác thực để tải lên tệp tùy ý. Các nhà nghiên cứu đã tìm ra 2 RestAPI (1 để tải lên mã độc, 1 để gọi mã độc) cho phép thực thi mà không yêu cầu xác thực. Để khai thác được lỗ hổng này, ta cần thực hiện 2 bước, tải lên tệp tin thực thi mã độc, gọi tệp tin mã độc đã tải lên. Hai endpoint gây ra lỗ hổng là 
`com.manageengine.s247.actions.S247Action#s247AgentInstallationProcess` và `com.adventnet.servicedesk.setup.action.ImportTechniciansAction` 

### S247Action 

Endpoint được gọi khi cần cài đặt mới các gói phần mềm mới. 
 
![image](https://user-images.githubusercontent.com/22276823/149799221-0ef5ab7c-8755-4064-924c-4b9e685e9bc5.png) 

![image](https://user-images.githubusercontent.com/22276823/149799437-3d4d641f-d73a-4f88-acef-879384db4c76.png) 

Bản chất của RestAPI này là gọi đến tiện ích `msiexec.exe` của windows được lưu tại đường dẫn `ManageEngine\ServicesDesk\bin` để cài đặt các gói phần mềm `Site24x7WindowsAgent.msi`. Một yêu cầu thông thường sẽ được chuyển thành commandline 
```
C:\Program Files\ManageEngine\ServiceDesk\bin\msiexec.exe /i Site24x7WindowsAgent.msi EDITA1=apikey /qn
``` 
Cấu hình Url được cấu hình trong `strust-config.xml` 
 
![image](https://user-images.githubusercontent.com/22276823/149887191-6dd47246-a513-4297-858e-d56ad4f9243b.png)  
 
### ImportTechnicians 
`ImportTechnicians` là một RestAPI khác, đây là API chính gây ra lỗ hổng. Nó cho phép tải lên tệp tùy ý mà không yêu cầu quyền xác thực. Các tệp tin tải lên được lưu tại `ManageEngine\ServicesDesk\bin`. 
 
![image](https://user-images.githubusercontent.com/22276823/149889118-6c61ad94-eb60-4d52-89ea-2a7f36b29942.png) 
  
![image](https://user-images.githubusercontent.com/22276823/149889920-7168848d-23f5-4e6a-ac71-7230a8368613.png) 

Điểm mấu chốt của lỗ hổng ở đây là `ImportTechnicians`. Nó cho phép tải lên tệp tùy ý, ghi đè nếu tệp tin sẵn có, không yêu cầu quyền xác thực. Đồng thời tệp tin được lưu tại `ManageEngine\ServicesDesk\bin`, cùng vị trí với `msiexec.exe`. Kẻ tấn công bây giờ chỉ cần tải lên mã độc với tên `msiexec.exe` và dùng `S247Action` để gọi tới mã độc. 

![image](https://user-images.githubusercontent.com/22276823/149889737-533b270c-fd81-4592-9c30-722deb1c0978.png) 
 
**Reference**  
[1] https://y4er.com/post/cve-2021-44077-zoho-manageengine-servicedesk-plus-pre-auth-rce/  
[2] https://cloud.tencent.com/developer/article/1922679  
[3] https://attackerkb.com/topics/qv2aD8YfMN/cve-2021-44077/rapid7-analysis?referrer=blog  

**Link tải**  
http://archives.manageengine.com/service-desk/   
