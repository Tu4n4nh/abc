## Overview  
Note lại cách quá trình setup môi trường cho pentest android apps. IOS cập nhật sau. Môi trường cài windows 10  
Công cụ:
1. [Genymotion](#genymotion)  
2. [Mobexler](#Mobexler)  
3. [Debug qua wifif](#debug-qua-wifi)  

## Genymotion  
Genymotion là phần mềm giả lập device đươc sử dụng rộng rãi. Để tải nó trước tiên cần phải đăng kí một tài khoản miễn phí trên trang chủ
https://www-v1.genymotion.com/account/create/  

### 1. Tải và cài đặt  
Để tải Genymotion, truy cập vào trang https://www.genymotion.com/download/  
Genymotion hoạt động cần phải có virtualbox để chạy device và bắt buộc phải cài trên máy thật, không thể cài trên máy ảo. Trang chủ khuyến khích tải bản có kèm luôn
virtualbox. Kinh nghiệm bản thân tải bản không đính kèm virtualbox, cài genymotion trước rồi cài virtualbox    
Sau khi tải về, chạy file cài với quyền Admin(Không bắt buộc chạy với quyền admin, nhưng nếu khi sử dụng có thể xảy ra lỗi)  
Trong quá trình cài đặt, sẽ cài luôn virtualbox nếu tải bản có đính kèm virtualbox  
  
### 2. Tạo máy ảo  
Khởi động ứng dụng, main page sẽ như thế này, đăng nhập bằng tài khoản đã tạo  
![image](https://user-images.githubusercontent.com/22276823/132122046-18274748-6a7d-4276-8ba0-2685b2782929.png)  
  
Sau khi đăng nhập, nhấn vào nút ![image](https://user-images.githubusercontent.com/22276823/132122074-d6ebaaf6-1c04-42db-b799-0765743e857c.png) để tạo một máy ảo mới  
Chọn loại device cần tạo  
![image](https://user-images.githubusercontent.com/22276823/132122088-ac5ccbc8-b56e-4c11-9ee4-6d2b199e2602.png)  

Nhấn `NEXT` hoặc double click để qua trang tiếp theo  
![image](https://user-images.githubusercontent.com/22276823/132122115-3f7714f4-d1cb-4cd3-a527-8e6d71fb8921.png)  

Tại đây đặt tên, có thể chỉnh sửa cấu hình tùy ý. Nhấn `INSTALL` để tạo máy ảo  
Tới đây Genymotion sẽ tự động tải các bản simulate của device về và tạo máy ảo trên virtualbox. Sau khi hoàn thành có thể kiểm tra bên virtualbox để thấy máy ảo mới
được tạo  

### 3. Khởi động máy ảo  
Màn hình chính sẽ xuất hiện máy ảo vừa tạo  
![image](https://user-images.githubusercontent.com/22276823/132122226-1965ce3c-3d17-485f-b43f-e926676886df.png)  

Double click hoặc Nhấn chọn ![image](https://user-images.githubusercontent.com/22276823/132122230-0c438931-764f-4066-8007-c0d9a9d2d62d.png) và chọn chọn `START`  
![image](https://user-images.githubusercontent.com/22276823/132122239-ab61f914-2e6c-4e12-b4db-9aa7a20769da.png)  

### Lỗi  
Note một số lỗi  
1. Quá trình không thể tạo máy ảo thành công  
Xóa, tắt Genymotion. `Run as Administrator`. Nếu không được thì xóa Genymotion, cài lại, lúc cài cũng `Run as Administrator`  
2. Quá trình khởi động máy ảo không thành công  
Kiểm tra card mạng. mỗi device sau khi tạo thành công virtualbox sẽ tạo một card mạng mới. Kiểm tra card mạng có được enable chưa, tính năng `Bridge Networking Driver`
đã được enable chưa
![image](https://user-images.githubusercontent.com/22276823/132122481-26c25848-33ba-4647-ab57-ac4e3af7f54d.png)  
Nếu kiểm tra xong vẫn không chạy được thì làm như cái số 1  

Tham khảo: https://support.genymotion.com/hc/en-us/articles/360002706697--An-error-has-occurred-while-trying-to-create-a-virtualbox-host-only-network-interface-Windows- 

## Mobexler  
Mobexler là một framework tích hợp các công cụ để dành cho việc pentest android và cả IOS. Framework này được build trên nền linux và đóng gói lại thành file ova. Một số tool nổi tiếng: ABD, Frida, Object, MobSF, Android studio, jadx, jd-gui, Bytecode viewer,... Nếu không thích dùng sẵn có, mình có thể tự cài từng tool mình thích.   
Tải file tại https://mobexler.com/download.htm  
Sau khi tải file, import vào máy ảo và khởi động. Mật khẩu mặc định là 12345  
Để kết nối thiết bị vào Mobexler, tham khảo tại https://mobexler.com/setup.htm  

## Debug qua wifi  
Đối với thiết bị để test, ngoài việc root hay jailbreak thì cần phải kết nối được điện thoại với PC để debug  
1. Bật chế độ development  
2. Setup burp  
3. Setup debug qua wifi  

### 1. Bật chế độ development  
Thiết bị demo samsung S8, Android 9  
> Setting > About phone > Software information > bấm liên tục vào Build number  

Sau khi thực hiện tại `Setting` sẽ xuất hiện mục `Developer options`như thế này  

![developer-mode](https://user-images.githubusercontent.com/22276823/134507739-741bb9b9-63d6-44fb-8553-76b4d9337062.jpeg)  

### 2. Setup debug qua wifi  
Ở đây chia làm 2 trường hợp. Android 11 trở lên [xem tại đây](https://developer.android.com/studio/run/device#wireless). Android 10 trở xuống làm như sau.  
1. Bật chế độ debug trên USB  
> Setting > Developer options > Enable USB debugging  

![enable-USB-debug](https://user-images.githubusercontent.com/22276823/134507880-099721a9-a915-4bbf-85d4-e2bf0eb8c3f5.jpeg)

2. Kết nối thiết bị vào máy tính(PC đã adb, tải [tại đây](https://developer.android.com/studio/releases/platform-tools))  
3. Sau khi kết nối, điện thoại sẽ nhảy thông báo, nhấn `OK`. Trước và sau khi `OK` sẽ thế này. Tới đây là PC và điện thoại đã kết nối vào được rồi. Ai thích debug qua wifi thì làm tiếp  
  
 ![image](https://user-images.githubusercontent.com/22276823/134482432-cb419901-e27d-43ec-b49d-2c85fae42a74.png)  
 
4. Trên PC, restart lại `adb` mode `TCP` port 5555  
```
adb tcpip 5555
````  

5. Rút dây cáp ra khỏi điện thoại  
6. Xem địa chỉ IP của điện thoại, tại PC connect vào IP với port 5555  
 
![image](https://user-images.githubusercontent.com/22276823/134502072-17035aa4-7114-4cfa-8797-4427926af350.png)


### 3. Setup burp  
Sau khi làm bước 1 và 2, chúng ta có thể connect với điện thoại từ PC. Để bắt được request của burp ta phải setup burp bắt request của điện thoại.  
***Lưu ý*** Đây chỉ là hướng dẫn setup burp để bắt request qua app. Hiện nay các app đều sử dụng tính năng SSL pinning nên tùy từng app mà cần thêm các cách bypass để có thể bắt
được request. Vì vậy khi bật proxy, sẽ có những app bị mất kết nối, do những app đó dùng SSL pining  
1. Thêm một listener mới trong burp. Mục đích để tách riêng request của điện thoại và của PC.   

![image](https://user-images.githubusercontent.com/22276823/134505086-86e4c945-5121-49e0-a01a-efc6ca546565.png) 

Nếu dùng thiết bị ảo thì xác định lớp mạng của thiết bị ảo và chọn gateway tương ứng   

![image](https://user-images.githubusercontent.com/22276823/134505256-fbd6fefb-6265-4e13-8aba-201ba4460fe7.png)

2. Setup proxy trên điện thoại. IP của PC, port như đã cấu hình trong burp   

![Setup-proxy](https://user-images.githubusercontent.com/22276823/134507575-44d481d3-ce1c-4020-bf62-6b21424f211f.jpeg)  

4. Tải burp CA về điện thoại(giống như PC)  
5. Cài đặt CA, truy cập thử để kiểm tra   

![Cai_CA](https://user-images.githubusercontent.com/22276823/134507365-f4f1cddc-8e49-4954-a1e8-597f675977c7.jpeg)





